Bootstrap: docker
From: eclipse-temurin:17-jdk-jammy

%environment
    export PATH="/opt/gedi/tools/Gedi/target:$PATH"
    export PATH="/opt/gedi/bin:$PATH"

%post
    set -eux
    # Install git, maven (linux package builder for GEDI), R, and dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        git \
        maven \
        passwd \
        r-base \
        r-base-dev \
        && rm -rf /var/lib/apt/lists/*
    
    INSTALL_DIR="/opt/gedi"

    # Install required R packages
    Rscript --vanilla -e 'install.packages(c("bit64", "ggplot2", "plyr", "data.table", "reshape2"), repos="https://cloud.r-project.org")'

    mkdir -p $INSTALL_DIR
    cd $INSTALL_DIR

    # clone GEDI version 1.0.6a (Apr 2024) with no commit history (--depth 1)
    git clone --branch Gedi_1.0.6a --depth 1 https://github.com/erhard-lab/gedi.git

    mkdir bin
    cd bin

    mvn -f $INSTALL_DIR/gedi/Gedi package 

    useradd -m -s /bin/bash gediuser
    chown -R gediuser:gediuser /opt/gedi

%test
    set -e
    
    # Test 1: Verify Java installation and version
    java -version
    
    # Test 2: Verify R installation and required packages
    Rscript --vanilla -e 'required <- c("bit64", "ggplot2", "plyr", "data.table", "reshape2"); stopifnot(all(required %in% installed.packages()[,"Package"]))'
    
    # Test 3: Verify GEDI executable exists and is in PATH
    which gedi
    
    # Test 4: Test GEDI basic execution (should print help/usage)
    gedi -h || gedi --help || gedi
    
    # Test 5: Verify GEDI jar file was built successfully
    test -f /opt/gedi/gedi/Gedi/target/Gedi-*.jar
    
    # Test 6: Test GEDI can list available programs
    gedi -e list 2>&1 | grep -i "Available programs" || true
    
    # Test 7: Verify user setup
    id gediuser
    
    # Test 8: Check directory permissions
    test -r /opt/gedi/gedi
    test -x /opt/gedi/bin
    
    echo "All installation tests passed successfully."

%runscript
    exec gedi "$@"